<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Cktsun Helper Login</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="https://unpkg.com/tailwindcss@2/dist/tailwind.min.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    />
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>
  </head>
  <body class="font-inter flex h-screen items-center justify-center bg-gray-100">
    <div class="rounded-md border border-gray-300 bg-white p-8 shadow-md">
      <h1 class="mb-2 text-xl font-bold">Cktsun Helper Endpoint</h1>
      <div class="mb-5 border-b-2"></div>
      <form id="login-form" action="/api/login" method="POST">
        <div class="mb-4">
          <label for="password" class="mb-2 block font-bold text-gray-700">Password:</label>
          <input
            type="password"
            id="password"
            name="password"
            class="focus:shadow-outline w-full rounded border px-3 py-2 leading-tight text-gray-700 focus:outline-none"
          />
        </div>
        <div
          class="h-captcha mb-4"
          data-sitekey="<%= HCAPTCHA_SITEKEY %>"
          data-callback="onToken"
        ></div>
        <button
          type="submit"
          class="focus:shadow-outline rounded bg-blue-500 px-4 py-2 font-bold text-white transition-colors duration-300 ease-in-out hover:bg-blue-700 hover:ring-2 hover:ring-blue-500 hover:ring-opacity-50 focus:outline-none"
        >
          Sign in
        </button>
      </form>
    </div>
    <script>
      let hcaptchaToken = null;

      // data-callback
      window.onToken = function (newToken) {
        hcaptchaToken = newToken;
      };

      const form = document.getElementById('login-form');
      form.addEventListener('submit', async event => {
        event.preventDefault();
        const password = document.getElementById('password').value;

        if (!hcaptchaToken || hcaptchaToken.length < 1) {
          alert('Please complete the hCaptcha challenge');
          return;
        }

        if (!password || password.length < 1) {
          alert('Please enter a password');
          return;
        }

        try {
          const response = await fetch('/api/login', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ password, hcaptchaToken }),
          });
          if (response.status !== 200) {
            throw new Error();
          }
          location.reload();
        } catch {
          alert('Login failed');
        }
      });

      function onSubmit(token) {
        document.getElementById('h-captcha-response').value = token;
      }
    </script>
  </body>
</html>
